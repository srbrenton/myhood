<html>
<head>

<!--Responsive Web Design Fundamentals-->
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>The Hood</title>

<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="css/hood.css">

</head>

<body>
<div class="container">
	<div class="row">

	<!-- inspired by http://opensoul.org/2011/06/23/live-search-with-knockoutjs/ -->
	<div class="col-md-4 col-sm-4 search">
		<form action="#">
			<input	placeholder="Where I've lived ..."
				type="search"
				name="q"
				data-bind="value: query, valueUpdate: 'keyup'" autocomplete="off" >
		</form>

	</div>		<!-- col-md-4 -->

<div class="col-md-8 col-sm-8 search">
<ul class="nav nav-tabs"class="nav nav-tabs"  data-bind="foreach: mapLocations">
	<li class="btn" data-bind="visible: visible()">
	<span data-bind="
		css: { hl: select() },
		text: name,
		event: { mouseover: $parent.highLightOn, mouseout: $parent.highLightOff, click: $parent.listClick }
	" ></span></li>
</ul>
</div>

<div class="row">
	<div class="col-md-12 col-sm-12">
		<div id="map">
		</div>			<!-- map -->
	</div>				<!-- col-md-12 -->
</div>					<!-- map row -->

</div>
</div><!--container-->

<script src="js/jQuery.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/knockout-3.2.0.js"></script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC5v06GI00VMZ07wHzXYTJdJKOy6HGM07Q&callback=initMap&libraries=places">
</script>

<script>
var contentStrings = [
	'Attending 2nd grade at John Marshall Elementary School',
	'Attending 3rd grade at Robert M. Pyles Elementary School',
	'Attending 5th grade at Robert M. Pyles Elementary School',
	'Attending 8th grade at Trident Junior High School',
	'Attending 12th grade at Loara High School',
	'Freshman at CSUF'
];

var myLocations = [
	{ name: 'Falmouth', addr: '2190 falmouth anaheim'},
	{ name: 'Chanticleer', addr: '8602 chanticleer stanton'},
	{ name: 'Lola', addr: '8891 lola anaheim'},
	{ name: 'Ball', addr: '2011 w ball rd anaheim'},
	{ name: 'Crone', addr: '1842 w crone rd anaheim'},
	{ name: 'Tiara', addr: '1639 s tiara way anaheim'}
];

function MapMarker(locInfo) {
	var self = this;
	self.name = locInfo.name;
	self.addr = locInfo.addr;
	self.marker = null;
	self.info = null;
	self.select = ko.observable(false);
	self.visible = ko.observable(true);
	self.bounce = ko.observable(false);
}

var mapLocations = ko.observableArray([
	new MapMarker(myLocations[0]),
	new MapMarker(myLocations[1]),
	new MapMarker(myLocations[2]),
	new MapMarker(myLocations[3]),
	new MapMarker(myLocations[4]),
	new MapMarker(myLocations[5])
]);

var myMap;
var myGeocoder;

function initMap() {

	myMap = new google.maps.Map(document.getElementById('map'), {
		zoom: 13,
		center: {lat: 33.83286, lng: -117.9587}
		}
	);

	myGeocoder = new google.maps.Geocoder();

	drop();

	// wait until markers have dropped
	setTimeout(addListeners, 800);

}

function drop() {
	clearMarkers();
	for ( var i in mapLocations() ) {
		addMarker(mapLocations()[i]);
	}
}

function clearMarkers() {
	for ( var i in mapLocations() ) {
		if ( mapLocations()[i].marker !== null ) {
			mapLocations()[i].marker = null;
		}
	}
}

function addMarker(location) {
	myGeocoder.geocode({'address': location.addr},(function(loc){return function(results, status) {
		if (status === google.maps.GeocoderStatus.OK) {
			loc.marker = new google.maps.Marker({
				map: myMap,
				title: results[0].formatted_address,
				position: results[0].geometry.location,
				animation: google.maps.Animation.DROP
			})
		}
		else {
//			alert(status);
		}
	}})(location));
}

// the markers have been dropped
function addListeners() {

	for ( var i in mapLocations() ) {
		mapLocations()[i].info = new google.maps.InfoWindow({content: contentStrings[i]});
//		mapLocations()[i].marker.addListener('click', (function(j){return function(){toggleBounce(j)}})(i));
	}
}

function toggleBounce(i) {
	if (mapLocations()[i].marker.getAnimation() !== null) {
		mapLocations()[i].marker.setAnimation(null);
	} else {
		mapLocations()[i].marker.setAnimation(google.maps.Animation.BOUNCE);
	}
}

function AppViewModel() {

	var self = this;
	var regex = new RegExp();
	var openInfo = null;

        self.query = ko.observable('');

        self.search = function(value) {

		closeInfos();

                // create a regex with the value in the search box
                regex.compile(value, 'i');

                // check each name in mapLocations for a match
                for (  var i in mapLocations() ) {
			var marker = mapLocations()[i].marker;
                        if ( regex.test(mapLocations()[i].name) ) {
                                mapLocations()[i].visible(true);
				marker.setMap(myMap);
                        }
                        else {
                                mapLocations()[i].visible(false);
				marker.setMap(null);
                        }
                }
        }

        self.query.subscribe(self.search);

	// toggle with: mapLocations()[0].visible(true)
	this.listClick = function(data) {
		var marker = data.marker;
		closeInfos();
		// console.log('click for: ' + data.addr);
		data.info.open(myMap, marker );
		data.marker.setAnimation(null);
		// console.log(data);
		// data.visible(false);
	}

	this.highLightOn = function(data) {
		data.select(true);
		data.bounce(true);
		data.marker.setAnimation(google.maps.Animation.BOUNCE);
	}

	this.highLightOff = function(data) {
		data.select(false);
		data.bounce(false);
		data.marker.setAnimation(null);
	}

	function closeInfos() {
		for (  var i in mapLocations() ) {
			mapLocations()[i].info.close();
		}
	}

	for ( index in myLocations ) {
		console.log(myLocations[index].addr);
	}

}

ko.applyBindings(new AppViewModel());

</script>
</body>
</html>
