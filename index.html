<html>

<head>

<!--Responsive Web Design Fundamentals-->
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>The Hood</title>

<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<style type="text/css">

	html, body { height: 100%; margin: 0; padding: 0; }
	/* Responsive Web Design Fundamentals */
	img, embed, object, video { max-width: 100%; }
	#map { height: 100%; }
	.hl { color:blue;background:pink; }
	.search { padding: 15px }

</style>

</head>

<body>
<div class="container">
<div class="row">

<!-- inspired by http://opensoul.org/2011/06/23/live-search-with-knockoutjs/ -->
<div class="col-md-4 col-sm-4 search">
<form action="#">
<input placeholder="Where I lived ..." type="search" name="q" data-bind="value: query, valueUpdate: 'keyup'" autocomplete="off">
</form>

</div>

<div class="col-md-8 col-sm-8 search">
<ul data-bind="foreach: mapLocations">
	<li data-bind="visible: visible()">
	<span data-bind="
		css: { hl: select() },
		text: name,
		event: { mouseover: $parent.highLightOn, mouseout: $parent.highLightOff, click: $parent.listClick }
	" ></span></li>
</ul>
</div>

<div class="row">
<div class=col-md-12>
<div id="map">
</div>
</div>
</div>
</div>
</div>

<script src="js/jQuery.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/knockout-3.2.0.js"></script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC5v06GI00VMZ07wHzXYTJdJKOy6HGM07Q&callback=initMap&libraries=places">
</script>

<script>
var contentStrings = [
	'Attending 2nd grade at John Marshall Elementary School',
	'Attending 3rd grade at Robert M. Pyles Elementary School',
	'Attending 5th grade at Robert M. Pyles Elementary School',
	'Attending 8th grade at Trident Junior High School',
	'Attending 12th grade at Loara High School',
	'Freshman at CSUF'
];

var myLocations = [
	{ name: 'Falmouth', addr: '2190 falmouth anaheim'},
	{ name: 'Chanticleer', addr: '8602 chanticleer stanton'},
	{ name: 'Lola', addr: '8891 lola anaheim'},
	{ name: 'Ball', addr: '2011 w ball rd anaheim'},
	{ name: 'Crone', addr: '1842 w crone rd anaheim'},
	{ name: 'Tiara', addr: '1639 s tiara way anaheim'}
];

function MapMarker(locInfo) {
	var self = this;
	self.name = locInfo.name;
	self.addr = locInfo.addr;
	self.marker = null;
	self.select = ko.observable(false);
	self.visible = ko.observable(true);
	self.bounce = ko.observable(false);
}

var mapLocations = ko.observableArray([
	new MapMarker(myLocations[0]),
	new MapMarker(myLocations[1]),
	new MapMarker(myLocations[2]),
	new MapMarker(myLocations[3]),
	new MapMarker(myLocations[4]),
	new MapMarker(myLocations[5])
]);

var myMap;
var myGeocoder;

function MyVM() {

var self = this;
var regex = new RegExp();

        self.query = ko.observable('');

        self.search = function(value) {
//              console.log(mapLocations());
                // create a regex with the value in the search box
                regex.compile(value, 'i');
                // check each name in mapLocations for a match
                for (  var i in mapLocations() ) {
                        if ( regex.test(mapLocations()[i].name) ) {
                                mapLocations()[i].visible(true);
                        }
                        else {
                                mapLocations()[i].visible(false);
                        }
                }
        }

        self.query.subscribe(self.search);

initMap = function() {

	myMap = new google.maps.Map(document.getElementById('map'), {
		zoom: 13,
		center: {lat: 33.83286, lng: -117.9587}
		}
	);

	myGeocoder = new google.maps.Geocoder();

	drop();

	// wait until markers have dropped
	setTimeout(addListeners, 800);

	// add some info windows
//	var infowindow = new google.maps.InfoWindow({content: contentStrings[0]});
//	myLocations()[0].marker.addListener('click', function() {infowindow.open(myMap, myLocations()[0].marker);});
//	console.log(myLocations()[0].marker);



}

function drop() {
	clearMarkers();
	for ( var i in mapLocations() ) {
		addMarker(mapLocations()[i]);
	}
}

function clearMarkers() {
	for ( var i in mapLocations() ) {
		if ( mapLocations()[i].marker !== null ) {
			mapLocations()[i].marker = null;
		}
	}
}

function addMarker(location) {
	myGeocoder.geocode({'address': location.addr},(function(loc){return function(results, status) {
		if (status === google.maps.GeocoderStatus.OK) {
			loc.marker = new google.maps.Marker({
				map: myMap,
				title: results[0].formatted_address,
				position: results[0].geometry.location,
				animation: google.maps.Animation.DROP
			})
		}
		else {
//			alert(status);
		}
	}})(location));
}

function addListeners() {
	var infowindow;
	for ( var i in mapLocations() ) {
//		infowindow = new google.maps.InfoWindow({content: contentStrings[i]});
//		infowindow = new google.maps.InfoWindow(function(j){return {content: contentStrings[j]}}(i));
mapLocations()[i].marker.addListener('click', (function(j){return function(){toggleBounce(j)}})(i));
//myLocations()[i].marker.addListener('click', (function(j){return function(){infowindow.open(myMap, myLocations()[j].marker)}})(i));
	}
//	console.log(myLocations()[0].marker);
}

function toggleBounce(i) {
	if (mapLocations()[i].marker.getAnimation() !== null) {
		mapLocations()[i].marker.setAnimation(null);
	} else {
		mapLocations()[i].marker.setAnimation(google.maps.Animation.BOUNCE);
	}
}

	// toggle with: mapLocations()[0].visible(true)
	this.listClick = function(data) {
		console.log('click for: ' + data.addr);
//		console.log(data);
//		data.visible(false);
	}

	this.highLightOn = function(data) {
	data.select(true);
	}


//self.highLightOn = function() {
//	// grab numeric part of span id
//	var myIndex =  (event.target.id.match(/li(\d)/))[1];
//	$(event.target).addClass('hl');
//	toggleBounce(myIndex);
//}


	this.highLightOff = function(data) {
		data.select(false);
	}

//self.highLightOff = function() {
//	// grab numeric part of span id
//	var myIndex =  (event.target.id.match(/li(\d)/))[1];
//	$(event.target).removeClass('hl');
//	toggleBounce(myIndex);
//}

for ( index in myLocations ) {
//	console.log(myLocations()[index].name);
	console.log(myLocations[index].addr);
}


}

ko.applyBindings(new MyVM());

</script>
</body>
</html>
