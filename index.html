<html>
<head>

<!--Responsive Web Design Fundamentals-->
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>The Hood</title>

<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="css/hood.css">

</head>

<body>
<div class="container">
	<div class="row">

	<!-- inspired by http://opensoul.org/2011/06/23/live-search-with-knockoutjs/ -->
	<div class="col-md-4 col-sm-4 search">
<!--		<form action=""> -->
<!--			<label for"search1">Type Here</lable>	-->
			<input	id="search1" placeholder="Where I've lived ..."
				autofocus
				list="myHomes"
				type="search"
				name="q"
				data-bind="value: query, valueUpdate: 'keyup'" autocomplete="off" >
			<datalist id="myHomes" data-bind="foreach: mapLocations">
				<option data-bind="text: name, visible: visible()"></option>
			</datalist>
<!--		<input type="button" value="push"> -->
<!--		</form> -->

	</div>		<!-- col-md-4 -->

<div class="col-md-8 col-sm-8 search">
<ul class="nav nav-tabs"class="nav nav-tabs"  data-bind="foreach: mapLocations">
	<li class="btn" data-bind="visible: visible()">
	<span data-bind="
		css: { hl: select() },
		text: name,
		event: { mouseover: $parent.highLightOn, mouseout: $parent.highLightOff, click: $parent.listClick }
	" ></span></li>
</ul>
</div>

<div class="row">
	<div class="col-md-12 col-sm-12">
		<div id="map">
		</div>			<!-- map -->
	</div>				<!-- col-md-12 -->
</div>					<!-- map row -->

</div>
</div><!--container-->

<script src="js/jQuery.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/knockout-3.2.0.js"></script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC5v06GI00VMZ07wHzXYTJdJKOy6HGM07Q&callback=initMap&libraries=places">
</script>

<script>
/*
 *	This array contains the source data the markers and info boxes
 */

var myLocations = [
	{ name: 'Falmouth',
	addr: '2190 falmouth anaheim',
	date: '1960-61',
	grade: '2',
	school: 'John Marshall Elementary',
	interest: 'The Three Rs',
	wikiData: null
	},
	{ name: 'Chanticleer',
	addr: '8602 chanticleer stanton',
	date: '1961-62',
	grade: '3',
	school: 'Robert M. Pyles Elementary',
	interest: 'Cub Scouts',
	wikiData: null
	},
	{ name: 'Lola',
	addr: '8891 lola anaheim',
	date: '1963-65',
	grade: '4-7',
	school: 'Robert M. Pyles Elementary',
	interest: 'Michael Faraday',
	wikiData: null
	},
	{ name: 'Ball',
	addr: '2011 w ball rd anaheim',
	date: '1966-68',
	grade: '8-9',
	school: 'Trident Junior High',
	interest: 'Chemistry',
	wikiData: null
	},
	{ name: 'Crone',
	addr: '1842 w crone rd anaheim',
	date: '1968-70',
	grade: '10- 12',
	school: 'Loara High',
	interest: 'Isaac Asimov',
	wikiData: null
	},
	{ name: 'Tiara',
	addr: '1639 s tiara way anaheim',
	date: '1970-71',
	grade: 'freshman',
	school: 'CSUF',
	interest: 'Rostropovich',
	wikiData: null
	}
];

/*
 *	Prepare to fire of the AJAX Wikipedia requests
 *	Save a 2D array of results for each interest in the myLocations array
 */

function wikiRequests() {

	var wikiUrl = 'http://en.wikipedia.org/w/api.php?action=opensearch&search=%query%&format=json&callback=wikiCallback';
	var thisRequest = { };

	for ( var i in myLocations ) {
		thisRequest.url = wikiUrl.replace('%query%', myLocations[i].interest);
		thisRequest.dataType = 'jsonp';
		thisRequest.success = (function(idx){return function(response) {
						myLocations[idx].wikiData = [response[1], response[3]];
						}}
					)(i);
		$.ajax(thisRequest);
//		console.log(thisRequest);
	}
}
		
wikiRequests();

/*
 *	Define an object to facilitate KnockoutJS functionality
 */

function MapMarker(locInfo) {
	var self = this;
	self.name = locInfo.name;
	self.addr = locInfo.addr;
	self.marker = null;
	self.info = null;
	self.select = ko.observable(false);
	self.visible = ko.observable(true);
	self.bounce = ko.observable(false);
}

/*
 *	Create an observableArray of MapMarkers populated with data from myLocations[]
 */

var mapLocations = ko.observableArray([
	new MapMarker(myLocations[0]),
	new MapMarker(myLocations[1]),
	new MapMarker(myLocations[2]),
	new MapMarker(myLocations[3]),
	new MapMarker(myLocations[4]),
	new MapMarker(myLocations[5])
]);

/*
 *	Create the map, markers, and info boxes
 */

var myMap;
var myGeocoder;

function initMap() {

	myMap = new google.maps.Map(document.getElementById('map'), {
		disableDefaultUI: true,
		zoom: 13,
		center: {lat: 33.83286, lng: -117.9587}
		}
	);

	myGeocoder = new google.maps.Geocoder();

	// create and drop the markers
	dropMarkers();

	// wait until markers have dropped
	setTimeout(addListeners, 800);

}

function dropMarkers() {
//	clearMarkers();
	for ( var i in mapLocations() ) {
		addMarker(mapLocations()[i]);
	}
}

function clearMarkers() {
	for ( var i in mapLocations() ) {
		if ( mapLocations()[i].marker !== null ) {
			mapLocations()[i].marker = null;
		}
	}
}

/*
 *	Use the Google Geocoder to get coordinates for each address and create the Markers
 */

function addMarker(location) {
	myGeocoder.geocode({'address': location.addr},(function(loc){return function(results, status) {
		if (status === google.maps.GeocoderStatus.OK) {
			loc.marker = new google.maps.Marker({
				map: myMap,
				title: results[0].formatted_address,
				position: results[0].geometry.location,
				animation: google.maps.Animation.DROP
			});
		}
		else {
//			alert(status);
		}
	}})(location));
}

/*
 * Here is a template and code to create the text for the info boxes
 */
var contentTemplate = '<p>I lived at %addr% while attending grade(s) ' +
			'%grade% at %school% during %dates% with an interest in %interest%.</p>';

function buildContent(i) {
	var thisItem;
	var wikiInfo;
	thisItem = contentTemplate.replace("%interest%", myLocations[i].interest);
	thisItem = thisItem.replace("%dates%", myLocations[i].date);
	thisItem = thisItem.replace("%school%", myLocations[i].school);
	thisItem = thisItem.replace("%grade%", myLocations[i].grade);
	thisItem = thisItem.replace("%addr%", mapLocations()[i].marker.title);
	
	wikiInfo = '<ul>';
	for ( var entries = 0; entries < myLocations[i].wikiData[0].length; entries++ ) {
		wikiInfo += '<li><a href="' + myLocations[i].wikiData[1][entries] + '">';
		wikiInfo += myLocations[i].wikiData[0][entries] + '</a></li>';
//		console.log(wikiInfo);
	}
	wikiInfo += '</ul>'
	return thisItem + wikiInfo;
}

/*
 *	The markers have been created and dropped, build and link the Info boxes
 */

function addListeners() {

	for ( var i in mapLocations() ) {
		mapLocations()[i].marker.addListener('click', (function(j){return function(){toggleBounce(j)}})(i));
		mapLocations()[i].info = new google.maps.InfoWindow({content:  buildContent(i)});
	}
}

/*
 *	If marker is clicked start bouncing and show info box
 *	Conversely, stop bouncing and hide the info box
 */

function toggleBounce(i) {
	if (mapLocations()[i].marker.getAnimation() !== null) {
		mapLocations()[i].marker.setAnimation(null);
		mapLocations()[i].info.close();
	} else {
		mapLocations()[i].marker.setAnimation(google.maps.Animation.BOUNCE);
		mapLocations()[i].info.open(myMap, mapLocations()[i].marker);
	}
}

/*
 * This must be the View Model
 */

function AppViewModel() {

	var self = this;
	var regex = new RegExp();
	var openInfo = null;

        self.query = ko.observable('');

        self.search = function(value) {

		closeInfos();

		// create a regex with the value in the search box
		regex.compile(value, 'i');

		// check each name in mapLocations for a match
		for (  var i in mapLocations() ) {
			var marker = mapLocations()[i].marker;
			if ( regex.test(mapLocations()[i].name) ) {
				mapLocations()[i].visible(true);
				marker.setMap(myMap);
			}
			else {
				mapLocations()[i].visible(false);
				marker.setMap(null);
			}
		}
	}

	self.query.subscribe(self.search);

	// toggle with: mapLocations()[0].visible(true)
	this.listClick = function(data) {
		var marker = data.marker;
		closeInfos();
		// console.log('click for: ' + data.addr);
		data.info.open(myMap, marker );
		data.marker.setAnimation(null);
		// console.log(data);
		// data.visible(false);
	}

	this.highLightOn = function(data) {
		data.select(true);
		data.bounce(true);
		data.marker.setAnimation(google.maps.Animation.BOUNCE);
	}

	this.highLightOff = function(data) {
		data.select(false);
		data.bounce(false);
//		data.info.close();
		data.marker.setAnimation(null);
	}

	function closeInfos() {
		for (  var i in mapLocations() ) {
			mapLocations()[i].info.close();
		}
	}

	for ( index in myLocations ) {
		console.log(myLocations[index].addr);
	}

}

ko.applyBindings(new AppViewModel());

</script>
</body>
</html>
